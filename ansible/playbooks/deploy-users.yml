---
# Main playbook to deploy SSH users to all Debian hosts
# This playbook is triggered by GitHub Actions

- name: Deploy SSH Users and Keys to Debian Hosts
  hosts: debian_hosts
  become: true
  gather_facts: true

  pre_tasks:
    - name: Display deployment information
      ansible.builtin.debug:
        msg:
          - "Deploying to host: {{ inventory_hostname }}"
          - "Environment: {{ environment | default('not specified') }}"
          - "Timestamp: {{ ansible_date_time.iso8601 }}"

    - name: Verify user mapping file exists
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/../../config/user-mapping.json"
      delegate_to: localhost
      register: user_mapping_stat
      run_once: true

    - name: Fail if user mapping file not found
      ansible.builtin.fail:
        msg: "User mapping file not found at {{ playbook_dir }}/../../config/user-mapping.json"
      when: not user_mapping_stat.stat.exists
      run_once: true

  roles:
    - role: ssh_user_management

  post_tasks:
    - name: Display deployment summary
      ansible.builtin.debug:
        msg: "Successfully deployed users to {{ inventory_hostname }}"

  handlers:
    - name: Restart SSHD
      ansible.builtin.service:
        name: sshd
        state: restarted
