---
# Configure SSH daemon to use both authorized_keys files

- name: Check if sshd_config.d directory exists
  ansible.builtin.stat:
    path: /etc/ssh/sshd_config.d
  register: sshd_config_d

- name: Configure SSH to use both authorized_keys files (via sshd_config.d)
  ansible.builtin.copy:
    content: |
      # SSH User Management - Use separate authorized_keys files
      # Generated by Ansible on {{ ansible_date_time.iso8601 }}
      #
      # This allows separation of manually managed keys and GitHub-imported keys
      # Manual keys: ~/.ssh/authorized_keys
      # GitHub keys: ~/.ssh/authorized_keys_github

      AuthorizedKeysFile .ssh/authorized_keys .ssh/authorized_keys_github
    dest: /etc/ssh/sshd_config.d/90-ssh-user-management.conf
    owner: root
    group: root
    mode: '0644'
    validate: 'sshd -t -f %s'
  when: sshd_config_d.stat.exists and sshd_config_d.stat.isdir
  notify: restart sshd
  tags: [sshd, config]

- name: Configure SSH to use both authorized_keys files (via sshd_config)
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^AuthorizedKeysFile'
    line: 'AuthorizedKeysFile .ssh/authorized_keys .ssh/authorized_keys_github'
    state: present
    validate: 'sshd -t -f %s'
  when: not (sshd_config_d.stat.exists and sshd_config_d.stat.isdir)
  notify: restart sshd
  tags: [sshd, config]

- name: Verify sshd configuration
  ansible.builtin.command: sshd -t
  changed_when: false
  tags: [sshd, verify]
