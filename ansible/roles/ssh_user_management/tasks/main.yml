---
# Main tasks for SSH user management role

- name: Ensure required packages are installed
  ansible.builtin.apt:
    name:
      - sudo
      - curl
      - python3
      - jq
      - openssh-server
    state: present
    update_cache: true
  tags: [setup, packages]

- name: Create log directory
  ansible.builtin.file:
    path: "{{ log_dir }}"
    state: directory
    mode: '0755'
  when: enable_logging
  tags: [setup]

- name: Create backup directory
  ansible.builtin.file:
    path: "{{ backup_dir }}"
    state: directory
    mode: '0700'
  when: create_backups
  tags: [setup]

- name: Configure SSH daemon for dual authorized_keys files
  ansible.builtin.include_tasks: configure_sshd.yml
  tags: [sshd]

- name: Load user mapping from file
  ansible.builtin.set_fact:
    user_config: "{{ lookup('file', user_mapping_file) | from_json }}"
  tags: [always]

- name: Display user count
  ansible.builtin.debug:
    msg: "Managing {{ user_config.users | length }} users"
  tags: [always]

- name: Process each user
  ansible.builtin.include_tasks: manage_user.yml
  loop: "{{ user_config.users }}"
  loop_control:
    loop_var: user_item
    label: "{{ user_item.local_user }}"
  tags: [users]

- name: Create deployment log entry
  ansible.builtin.lineinfile:
    path: "{{ log_dir }}/deployment.log"
    line: "{{ ansible_date_time.iso8601 }} - Deployed {{ user_config.users | length }} users to {{ inventory_hostname }}"
    create: true
    mode: '0644'
  when: enable_logging
  tags: [logging]
