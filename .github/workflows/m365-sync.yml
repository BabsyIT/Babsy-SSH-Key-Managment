name: M365 User Sync

#on:
  # St√ºndliche Synchronisation
#  schedule:
#    - cron: '0 * * * *'  # Every hour at :00

  # Manuelle Ausf√ºhrung
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force full synchronization'
        required: false
        default: 'false'

  # Bei Push zu main (f√ºr Testing)
  push:
    branches:
      - main
    paths:
      - 'scripts/m365-user-sync.py'
      - 'config/examples/m365-config.json.example'
      - '.github/workflows/m365-sync.yml'

jobs:
  sync-m365-users:
    name: Sync Users from Microsoft 365
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          pip install requests

      - name: Run M365 user synchronization
        env:
          # M365 Authentication
          M365_TENANT_ID: ${{ secrets.M365_TENANT_ID }}
          M365_CLIENT_ID: ${{ secrets.M365_CLIENT_ID }}
          M365_CLIENT_SECRET: ${{ secrets.M365_CLIENT_SECRET }}

          # M365 Configuration
          M365_IT_GROUP_NAME: ${{ secrets.M365_IT_GROUP_NAME }}
          M365_GITHUB_USERNAME_FIELD: ${{ secrets.M365_GITHUB_USERNAME_FIELD }}

          # User Configuration
          USER_MAPPING_FILE: ${{ github.workspace }}/config/user-mapping.json
          DEFAULT_SUDO_ACCESS: limited
          DEFAULT_GROUPS: '["users", "sudo", "docker", "adm"]'
          DEFAULT_SUDO_COMMANDS: '["/usr/bin/systemctl restart *", "/usr/bin/systemctl reload *", "/usr/bin/systemctl status *", "/usr/bin/docker *", "/usr/bin/journalctl *"]'
        run: |
          python3 scripts/m365-user-sync.py
        continue-on-error: false

      - name: Check if user-mapping.json was updated
        id: check_changes
        run: |
          if git diff --quiet config/user-mapping.json; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes detected in user-mapping.json"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changes detected in user-mapping.json"
          fi

      - name: Display changes
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          echo "=== Changes in user-mapping.json ==="
          git diff config/user-mapping.json

      - name: Commit and push changes
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions M365 Sync"
          git add config/user-mapping.json
          git commit -m "Auto-sync: Update user-mapping.json from M365 IT-Team

          Synced at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          Triggered by: ${{ github.event_name }}
          Workflow: ${{ github.workflow }}
          Run: ${{ github.run_number }}"
          git push

      - name: Trigger user deployment
        if: steps.check_changes.outputs.changed == 'true'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: users-updated
          client-payload: '{"source": "m365-sync", "timestamp": "${{ github.event.head_commit.timestamp }}"}'

      - name: Summary
        if: always()
        run: |
          echo "### M365 User Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes detected**: ${{ steps.check_changes.outputs.changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

          if [ -f config/user-mapping.json ]; then
            USER_COUNT=$(jq '.users | length' config/user-mapping.json)
            echo "- **Total users**: $USER_COUNT" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create GitHub Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® M365 User Sync Failed - ' + new Date().toISOString().split('T')[0],
              body: `## M365 User Synchronization Failure Report

            **Workflow Run:** [#${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            **Triggered by:** ${context.eventName}
            **Branch:** ${context.ref}
            **Commit:** ${context.sha.substring(0, 7)}
            **Timestamp:** ${new Date().toISOString()}

            ### ‚ö†Ô∏è Error Occurred

            The M365 user synchronization workflow has failed. This means users from the IT-Team group in Microsoft 365 could not be synchronized.

            ### üîç Possible Causes

            - ‚ùå **Invalid M365 Credentials:** Check GitHub secrets (M365_TENANT_ID, M365_CLIENT_ID, M365_CLIENT_SECRET)
            - ‚ùå **Missing API Permissions:** Verify User.Read.All, Group.Read.All, Directory.Read.All are granted
            - ‚ùå **IT-Team Group Not Found:** Group "${process.env.M365_IT_GROUP_NAME || 'IT-Team'}" may not exist in M365
            - ‚ùå **Network Connectivity:** Temporary connection issues with Microsoft Graph API
            - ‚ùå **Extension Attributes Not Set:** Users may be missing GitHub usernames in extensionAttribute1

            ### üõ†Ô∏è Troubleshooting Steps

            1. **Verify GitHub Secrets:**
               \`\`\`bash
               Settings ‚Üí Secrets and variables ‚Üí Actions
               # Check all M365_* secrets are configured
               \`\`\`

            2. **Check Azure AD App Permissions:**
               \`\`\`
               Azure Portal ‚Üí App registrations ‚Üí SSH-User-Management
               ‚Üí API permissions ‚Üí Verify admin consent granted
               \`\`\`

            3. **Verify IT-Team Group:**
               \`\`\`powershell
               Connect-AzureAD
               Get-AzureADGroup -Filter "DisplayName eq 'IT-Team'"
               \`\`\`

            4. **Test Connection Manually:**
               \`\`\`bash
               # See SETUP-GITHUB-SECRETS.md for test script
               \`\`\`

            ### üìã Quick Fix

            \`\`\`bash
            # Re-run the workflow manually after fixing
            gh workflow run m365-sync.yml
            \`\`\`

            ### üìä Workflow Logs

            [View detailed logs](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            ---

            _This issue was automatically created by GitHub Actions._
            _Please investigate and close this issue once the problem is resolved._`,
              labels: ['bug', 'automation', 'm365-sync', 'high-priority', 'needs-investigation']
            });

            console.log(`Created issue #${issue.data.number}`);
